<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</title>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    body { margin:0; font-family:sans-serif; background:#f0f0f0; text-align:center; }
    h1 { margin:10px 0; }

    #mode button{
      font-size:18px; font-weight:800;
      padding:10px 18px; margin:5px;
      border-radius:12px; border:3px solid #ff4444;
      background:#fff; color:#ff4444;
      min-width:120px;
    }
    #mode button.active{ background:#ff4444; color:#fff; }

    video{
      width:90%; max-width:420px;
      border:5px solid #ff4444;
      border-radius:20px;
      background:#000;
    }

    #msg{ margin:10px 0; font-weight:800; color:#333; }

    #enableSound{
      font-size:16px;
      padding:10px 16px;
      border-radius:10px;
      border:none;
      background:#333;
      color:#fff;
    }
  </style>
</head>

<body>
  <h1>ãƒŸã‚³ã‚·ãƒ¤å—ä»˜</h1>

  <div id="mode">
    <button id="btnIn" class="active" type="button">å…¥å®¤</button>
    <button id="btnOut" type="button">é€€å®¤</button>
  </div>

  <video id="video" playsinline></video>

  <div id="msg">QRã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
  <button id="enableSound" type="button">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>

<script>
/* ===== è¨­å®šï¼ˆå¿…è¦ãªã‚‰ã“ã“ã ã‘å¤‰æ›´ï¼‰ ===== */
const scriptUrl = "https://script.google.com/macros/s/AKfycbwA9v9s1mGSwiGfPoBwh339dbXSavqGhC-DH-uR-OWu27eXmyZw3UR3bikBZrJGdm87/exec";
const token = "MIKOSHIYA_2026_tencho_8F3kX2p9Qw7LmN4";
const device = "mikoshiya-ipad-front";

/* ===== DOM ===== */
const msg = document.getElementById("msg");
const btnIn = document.getElementById("btnIn");
const btnOut = document.getElementById("btnOut");
const video = document.getElementById("video");
const enableBtn = document.getElementById("enableSound");

/* ===== åŠ¹æœéŸ³ï¼ˆsounds/ é…ä¸‹ï¼‰ ===== */
const soundIn  = new Audio("sounds/in.mp3");
const soundOut = new Audio("sounds/out.mp3");
soundIn.preload  = "auto";
soundOut.preload = "auto";
// å¿…è¦ãªã‚‰éŸ³é‡ï¼ˆ0.0ã€œ1.0ï¼‰
// soundIn.volume = 0.8; soundOut.volume = 0.8;

/* ===== iPad Safariï¼šãƒœã‚¿ãƒ³ã§éŸ³ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼ˆæœ€å®‰å®šï¼‰ ===== */
let audioUnlocked = false;

enableBtn.addEventListener("click", async () => {
  try {
    // iOSã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå†…ã§ play()ã€ãŒå¿…é ˆ
    soundIn.muted = true;
    await soundIn.play();
    soundIn.pause();
    soundIn.currentTime = 0;
    soundIn.muted = false;

    soundOut.muted = true;
    await soundOut.play();
    soundOut.pause();
    soundOut.currentTime = 0;
    soundOut.muted = false;

    audioUnlocked = true;
    msg.textContent = "ğŸ”Š éŸ³OKï¼QRã‚’ã‹ã–ã—ã¦ã­";
    enableBtn.style.display = "none";
  } catch (e) {
    audioUnlocked = false;
    msg.textContent = "âš ï¸ éŸ³ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã­";
  }
});

/* ===== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ===== */
let mode = "IN";

btnIn.addEventListener("click", () => setMode("IN"));
btnOut.addEventListener("click", () => setMode("OUT"));

function setMode(m){
  mode = m;
  btnIn.classList.toggle("active", m==="IN");
  btnOut.classList.toggle("active", m==="OUT");
  msg.textContent = (m==="IN")
    ? "å…¥å®¤ãƒ¢ãƒ¼ãƒ‰ï¼šQRã‚’ã‹ã–ã—ã¦ãã ã•ã„"
    : "é€€å®¤ãƒ¢ãƒ¼ãƒ‰ï¼šQRã‚’ã‹ã–ã—ã¦ãã ã•ã„";
}

/* ===== ã‚«ãƒ¡ãƒ©èµ·å‹• ===== */
navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
  .then(stream => {
    video.srcObject = stream;
    video.play();
    requestAnimationFrame(scan);
  })
  .catch(() => {
    msg.textContent = "ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆSafariã®ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªï¼‰";
    alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã›ã‚“ã€‚Safariã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
  });

/* ===== QRèª­ã¿å–ã‚Š ===== */
const COOLDOWN_MS = 3000;      // åŒä¸€QRã®çŸ­æ™‚é–“é€£æ‰“å¯¾ç­–
const OK_LOCK_MS = 20000;      // â˜…OKå¾Œã€å…¨QRã‚’20ç§’é–“å®Œå…¨ç„¡åŠ¹åŒ–
let lockUntil = 0;             // ã“ã®æ™‚åˆ»ã¾ã§èª­ã¿å–ã‚Šç„¡åŠ¹

let lastId = "";
let lastAt = 0;
let sending = false;

// canvasä½¿ã„å›ã—
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

function scan(){
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(img.data, img.width, img.height);

    if (code) handleScan(code.data);
  }
  requestAnimationFrame(scan);
}

function handleScan(raw){
  const now = Date.now();

  // â˜…OKå¾Œ20ç§’ãƒ­ãƒƒã‚¯ï¼šã“ã®é–“ã¯â€œèª°ã®QRã§ã‚‚â€å®Œå…¨ç„¡è¦–
  if (now < lockUntil) return;

  const id = String(raw).trim();
  if (!id) return;
  if (sending) return;

  // åŒã˜QRã®çŸ­æ™‚é–“é€£æ‰“ã‚’æŠ‘åˆ¶
  if (id === lastId && (now - lastAt) < COOLDOWN_MS) return;

  lastId = id;
  lastAt = now;
  send(id);
}

/* ===== é€ä¿¡ ===== */
async function send(id){
  sending = true;
  const label = (mode === "IN") ? "å…¥å®¤" : "é€€å®¤";
  msg.textContent = `${id} ã•ã‚“ ${label} é€ä¿¡ä¸­â€¦`;

  try{
    const url =
      `${scriptUrl}?id=${encodeURIComponent(id)}` +
      `&mode=${encodeURIComponent(mode)}` +
      `&token=${encodeURIComponent(token)}` +
      `&device=${encodeURIComponent(device)}` +
      `&_=${Date.now()}`;

    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);

    msg.textContent = `${id} ã•ã‚“ ${label} OKï¼`;

    // â˜…ã“ã“ã§20ç§’ãƒ­ãƒƒã‚¯é–‹å§‹
    lockUntil = Date.now() + OK_LOCK_MS;

    // æˆåŠŸæ™‚ã®åŠ¹æœéŸ³ï¼ˆiPadã¯å…ˆã«ã€ŒéŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€ãŒå¿…è¦ï¼‰
    if (audioUnlocked) {
      if (mode === "IN") {
        soundIn.currentTime = 0;
        soundIn.play();
      } else {
        soundOut.currentTime = 0;
        soundOut.play();
      }
    }

    // ä»»æ„ï¼šå—ä»˜å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ­ãƒƒã‚¯ä¸­ã®æ¡ˆå†…ï¼‰
    setTimeout(() => {
      // ãƒ­ãƒƒã‚¯ä¸­ã¯è¡¨ç¤ºã‚’å›ºå®šï¼ˆæ¬¡ã®æ–¹ã©ã†ãï¼‰
      if (Date.now() < lockUntil) {
        const sec = Math.ceil((lockUntil - Date.now()) / 1000);
        msg.textContent = `å—ä»˜å®Œäº†ã€‚æ¬¡ã®æ–¹ã©ã†ãï¼ˆã‚ã¨${sec}ç§’ï¼‰`;
      }
    }, 100);

  } catch(e){
    msg.textContent = "é€šä¿¡å¤±æ•—â€¦ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ã­";
    lastAt = 0;      // å¤±æ•—æ™‚ã¯ã™ãå†ãƒˆãƒ©ã‚¤å¯
    lockUntil = 0;   // å¤±æ•—æ™‚ã¯ãƒ­ãƒƒã‚¯ã—ãªã„
  } finally {
    setTimeout(()=> sending = false, 600);
  }
}

// ãƒ­ãƒƒã‚¯ä¸­ã®æ®‹ã‚Šç§’ã‚’æ›´æ–°ï¼ˆè¦‹ã‚„ã™ãã™ã‚‹ï¼šä»»æ„ï¼‰
setInterval(() => {
  if (Date.now() < lockUntil) {
    const sec = Math.ceil((lockUntil - Date.now()) / 1000);
    msg.textContent = `å—ä»˜å®Œäº†ã€‚æ¬¡ã®æ–¹ã©ã†ãï¼ˆã‚ã¨${sec}ç§’ï¼‰`;
  }
}, 500);

</script>
</body>
</html>
